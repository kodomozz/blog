## NAT

![NAT](../assets/nat_guide.jpg)

### 什么是NAT协议

NAT（Network Address Translation）协议：在私有地址和全局地址之间转换的协议。是一种把内部私有网络地址（IP地址）翻译成合法网络IP地址的技术。因此我们可以认为，NAT在一定程度上，能够有效的解决公网地址不足的问题。

### 分类

- 静态NAT(Static NAT)
- 动态地址NAT(Pooled NAT)
- 网络地址端口转换NAPT（Port-Level NAT)
> 静态NAT和动态地址NAT由于并不能减少ip地址，所以用的较少

### 应用
NAT主要可以实现以下几个功能：数据包伪装、平衡负载、端口转发和透明代理。

**数据伪装**: 可以将内网数据包中的地址信息更改成统一的对外地址信息，不让内网主机直接暴露在因特网上，保证内网主机的安全。同时，该功能也常用来实现共享上网。

**端口转发**: 当内网主机对外提供服务时，由于使用的是内部私有IP地址，外网无法直接访问。因此，需要在网关上进行端口转发，将特定服务的数据包转发给内网主机。

**负载平衡**: 目的地址转换NAT可以重定向一些服务器的连接到其他随机选定的服务器。（不是很明白）

**透明代理**: NAT可以把连接到因特网的HTTP连接重定向到一个指定的HTTP代理服务器以缓存数据和过滤请求。一些服务提供商就使用这种技术来减少带宽的使用而不用让他们的客户配置他们的浏览器支持代理连接。

### 图解

![NAT](../assets/nat_guide.jpg)

### 实例

一般私人用户使用的NAT实际上是NAPT(network address ports translator)，即网络地址和(TCP/UDP)端口转换。

**内网客户端A IP: 10.0.0.10**
**内网客户端B IP: 10.0.0.11**
**TCP端口号: 80**
**路由器外网IP: 11.1.1.1**
**服务器外网IP: 22.2.2.2**

则在A通信开始时，路由器通过NAT将源数据包中的源IP由10.0.0.10转换为11.1.1.1，并且将TCP端口号转换为1000(可以为其他值)，然后在路由器内部生成转换表(session)：

**源地址：10.0.0.10:80⇄11.1.1.1:1000**
**目的地址：22.2.2.2**

而在B通信时，将TCP端口号转换为1001(可以为其他值)

**源地址：10.0.0.11:80⇄11.1.1.1:1001**
**目的地址：22.2.2.2**

当收到来自服务器IP的数据包时，将客户端IP地址和端口号进行逆向转换后转发给内网客户端。而当收到未知IP地址(本例中指22.2.2.2以外的IP地址)发来的数据包时，则将其丢弃不进行转发。该转换表在TCP建立发送SYN包时自动生成，收到FIN包确认关闭连接时删除。